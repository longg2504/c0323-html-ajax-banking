<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List of customers</title>
    <link rel="stylesheet" href="./assets/bootstrap/v-5.3.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="./assets/fontawesome/v-5.15.4/css/all.min.css">
    <link rel="stylesheet" href="./assets/sweetalert2/sweetalert2.min.css">
    <link rel="stylesheet" href="./assets/css/style.css">

</head>

<body>
    <div class="container">
        <header>
            <nav class="navbar navbar-expand-lg bg-body-navbar">
                <div class="container-fluid">
                    <h1 class="navbar-brand">List of customers</h1>
                    <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                        data-bs-target="#navbarScroll" aria-controls="navbarScroll" aria-expanded="false"
                        aria-label="Toggle navigation">
                        <span class="navbar-toggler-icon"></span>
                    </button>
                    <div class="collapse navbar-collapse" id="navbarScroll">
                        <div class="navbar-nav me-auto my-2 my-lg-0 navbar-nav-scroll"
                            style="--bs-scroll-height: 100px;">

                        </div>
                        <form class="d-flex" role="search">
                            <button class="btn btn-outline-light me-3" type="button">
                                <i class="fas fa-history"></i>
                                Transfer history
                            </button>
                            <button class="btn btn-outline-light" type="button" id="btnShowCreateModal">
                                <i class="fas fa-user-plus"></i>Create
                            </button>
                        </form>
                    </div>
                </div>
            </nav>
        </header>

        <div class="content">
            <table id="tblCustomer" class="table table-hover">
                <thead>
                    <tr>
                        <th class="text-center" scope="col">#</th>
                        <th scope="col">Full Name</th>
                        <th scope="col">Email</th>
                        <th class="text-center" scope="col">Phone</th>
                        <th class="text-center" scope="col">Balance</th>
                        <th class="text-center" scope="col">Address</th>
                        <th colspan="5" class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody id="tbodyCustomer">


                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal create -->
    <div class="modal fade" id="modalCreate" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal create customer</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form class="forms-sample" method="post" id="frmCreate">
                        <div class="row">
                            <div class="form-group col-6">
                                <label for="title">Full Name</label>
                                <input type="text" class="form-control" id="fullNameCre" name="fullNameCre"
                                    placeholder="Enter title">
                            </div>
                            <div class="form-group col-6">
                                <label for="price">Email</label>
                                <input type="email" class="form-control" id="emailCre" name="emailCre"
                                    placeholder="Enter price">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="form-group col-6">
                                <label for="summary">Phone</label>
                                <input type="tel" class="form-control" id="phoneCre" name="phoneCre"
                                    placeholder="Enter summary">
                            </div>
                            <div class="form-group col-6">
                                <label for="description">Address</label>
                                <input type="text" class="form-control" id="addressCre" name="addressCre"
                                    placeholder="Enter description">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnCreate" class="btn btn-outline-primary">Create</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal update -->
    <div class="modal fade" id="modalUpdate" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false"
        aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5">Modal update customer</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="error-area" style="color: red;"></div>
                    <form class="forms-sample" method="post">
                        <div class="row">
                            <div class="form-group col-6">
                                <label for="title">Full Name</label>
                                <input type="text" class="form-control" id="fullNameUp" name="fullNameUp"
                                    placeholder="Enter title">
                            </div>
                            <div class="form-group col-6">
                                <label for="price">Email</label>
                                <input type="email" class="form-control" id="emailUp" name="emailUp"
                                    placeholder="Enter price">
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="form-group col-6">
                                <label for="summary">Phone</label>
                                <input type="tel" class="form-control" id="phoneUp" name="phoneUp"
                                    placeholder="Enter summary">
                            </div>
                            <div class="form-group col-6">
                                <label for="description">Address</label>
                                <input type="text" class="form-control" id="addressUp" name="addressUp"
                                    placeholder="Enter description">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnUpdate" class="btn btn-outline-secondary">Update</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Deposit -->
    <div class="modal fade" id="modalDeposit" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
        data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Modal deposit</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label for="fullNameDep">Full Name</label>
                                <input type="text" id="fullNameDep" class="form-control" readonly>
                            </div>
                            <div class="col-lg-6">
                                <label for="emailDep">Email</label>
                                <input type="email" id="emailDep" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label for="balanceDep">Current balance</label>
                                <input type="tel" id="balanceDep" class="form-control" readonly>
                            </div>
                            <div class="col-lg-6">
                                <label for="transactionAmountDep">Transaction Amount</label>
                                <input type="text" id="transactionAmountDep" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnDeposit" class="btn btn-outline-success">Deposit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Withdraw -->
    <div class="modal fade" id="mdWithdraw" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
        data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Modal Withdraw</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label for="fullNameDep">Full Name</label>
                                <input type="text" id="fullNameWd" class="form-control" readonly>
                            </div>
                            <div class="col-lg-6">
                                <label for="emailDep">Email</label>
                                <input type="email" id="emailWd" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-6">
                                <label for="balanceDep">Current balance</label>
                                <input type="tel" id="balanceWd" class="form-control" readonly>
                            </div>
                            <div class="col-lg-6">
                                <label for="transactionAmounWd">Transaction Amount</label>
                                <input type="text" id="transactionAmountWd" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnWithdraw" class="btn btn-outline-success">Withdraw</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal transfer -->
    <div class="modal fade" id="mdTransfer" tabindex="-1" aria-hidden="true" data-bs-backdrop="static"
        data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="exampleModalLabel">Modal transfer</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post">
                        <div class="row mb-3">
                            <div class="col-lg-4">
                                <label for="fullNameSent">Full Name</label>
                                <input type="text" id="fullNameSent" class="form-control" readonly>
                            </div>
                            <div class="col-lg-4">
                                <label for="recipientSelect">Recipient</label>
                                <select class="form-select" name="recipient.id" id="recipientSelect">
                                    <option value="" selected disabled>Select recipient</option>
                                </select>
                            </div>
                            <div class="col-lg-4">
                                <label for="balanceSent">Current balance</label>
                                <input type="tel" id="balanceSent" class="form-control" readonly>
                            </div>
                        </div>
                        <div class="row mb-3">

                            <div class="col-lg-4">
                                <label for="transactionAmountSent">Transaction Amount</label>
                                <input type="text" id="transactionAmountSent" class="form-control">
                            </div>
                            <div class="col-lg-4">
                                <label for="transactionAmountFee">Transaction Fee (10%)</label>
                                <input type="text" id="transactionAmountFee" class="form-control" readonly>
                            </div>
                            <div class="col-lg-4">
                                <label for="transactionAmountTotal">Transaction Total</label>
                                <input type="text" id="transactionAmountTotal" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" id="btnTransfer" class="btn btn-outline-success">Transfer</button>
                </div>
            </div>
        </div>
    </div>


    <script src="./assets/jquery/jquery-3.7.0.min.js"></script>
    <script src="./assets/bootstrap/v-5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="./assets/sweetalert2/sweetalert2.all.min.js"></script>
    <script src="./assets/js/app.js"></script>

    <script>

        const page = {
            url: {
                getAllCustomers: App.API_CUSTOMER + '?deleted=0',
                getCustomerById: App.API_CUSTOMER,
                createCustomer: App.API_CUSTOMER,
                updateCustomer: App.API_CUSTOMER,
                incrementBalance: App.API_CUSTOMER,
                descrementBalance: App.API_CUSTOMER,
                deposit: App.API_DEPOSIT,
                withdraw: App.API_WITHDRAW
            },
            elements: {

            },
            loadData: {

            },
            commands: {

            },
            dialogs: {
                elements: {},
                commands: {}
            },
            initializeControlEvent: {}
        }

        let customerId = 0;
        let customer = new Customer();
        let deposit = new Deposit();
        let withdraw = new Withdraw();
        let transfer = new Transfer();

        page.elements.btnShowCreateModal = $('#btnShowCreateModal');
        page.elements.tbCustomerBody = $('#tbodyCustomer');

        page.dialogs.elements.modalCreate = $('#modalCreate');
        page.dialogs.elements.frmCreate = $('#frmCreate');
        page.dialogs.elements.fullNameCre = $('#fullNameCre');
        page.dialogs.elements.emailCre = $('#emailCre');
        page.dialogs.elements.phoneCre = $('#phoneCre');
        page.dialogs.elements.addressCre = $('#addressCre');
        page.dialogs.elements.btnCreate = $('#btnCreate');

        page.dialogs.elements.modalUpdate = $('#modalUpdate');
        page.dialogs.elements.fullNameUp = $('#fullNameUp');
        page.dialogs.elements.emailUp = $('#emailUp');
        page.dialogs.elements.phoneUp = $('#phoneUp');
        page.dialogs.elements.addressUp = $('#addressUp');
        page.dialogs.elements.btnUpdate = $('#btnUpdate');

        page.dialogs.elements.modalDeposit = $('#modalDeposit');
        page.dialogs.elements.fullNameDep = $('#fullNameDep');
        page.dialogs.elements.emailDep = $('#emailDep');
        page.dialogs.elements.balanceDep = $('#balanceDep');
        page.dialogs.elements.transactionAmountDep = $('#transactionAmountDep');
        page.dialogs.elements.btnDeposit = $('#btnDeposit');

        page.dialogs.elements.modalWithdraw = $('#mdWithdraw');
        page.dialogs.elements.fullNameWd = $('#fullNameWd');
        page.dialogs.elements.emailWd = $('#emailWd');
        page.dialogs.elements.balanceWd = $('#balanceWd');
        page.dialogs.elements.transactionAmountWd = $('#transactionAmountWd');
        page.dialogs.elements.btnWithdraw = $('#btnWithdraw');

        page.dialogs.elements.modalTransfer = $('#mdTransfer');
        page.dialogs.elements.fullNameSent = $('#fullNameSent');
        page.dialogs.elements.balanceSent = $('#balanceSent');
        page.dialogs.elements.transactionAmountSent = $('#transactionAmountSent');
        page.dialogs.elements.transactionAmountFee = $('#transactionAmountFee');
        page.dialogs.elements.btnTransfer = $('#btnTransfer');




        page.commands.renderCustomer = (obj) => {
            return `
                <tr id="tr_${obj.id}">
                    <td class="text-center">${obj.id}</td>
                    <td>${obj.fullName}</td>
                    <td>${obj.email}</td>
                    <td class="text-center">${obj.phone}</td>
                    <td class="text-center num-space">${obj.balance}</td>
                    <td class=text-center>${obj.address}</td>
                    <td>
                        <button class="btn btn-outline-secondary edit" data-id="${obj.id}">
                        <i class="fa fa-pencil-alt"></i>
                    </button>
                    <button class="btn btn-outline-success deposit" data-id="${obj.id}">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="btn btn-outline-warning withdraw" data-id="${obj.id}">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="btn btn-outline-primary transfer" data-id="${obj.id}">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                    <button class="btn btn-outline-danger delete" data-id='${obj.id}'">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                    </td>
                </tr>
            `;
        }

        page.commands.getAllCustomers = () => {
            page.elements.tbCustomerBody.empty();

            $.ajax({
                type: 'GET',
                url: page.url.getAllCustomers
            })
                .done((data) => {
                    console.log(data);
                    data.forEach(item => {
                        const str = page.commands.renderCustomer(item);
                        page.elements.tbCustomerBody.prepend(str);
                    });
                })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.commands.getCustomerById = (id) => {
            return $.ajax({
                type: 'get',
                url: page.url.getCustomerById + '/' + id,
            });
        }

        

        page.commands.handleAddEventShowModalUpdate = (customerId) => {
            page.commands.getCustomerById(customerId).then((data) => {
                page.dialogs.elements.fullNameUp.val(data.fullName);
                page.dialogs.elements.emailUp.val(data.email);
                page.dialogs.elements.phoneUp.val(data.phone);
                page.dialogs.elements.addressUp.val(data.address);

                page.dialogs.elements.modalUpdate.modal('show');

            })
                .catch((error) => {
                    console.log(error);
                });
        }

        page.commands.handleAddEventShowModalDeposit = (customerId) => {
            page.commands.getCustomerById(customerId).then((data) => {
                customer = data;
                page.dialogs.elements.fullNameDep.val(customer.fullName);
                page.dialogs.elements.emailDep.val(customer.email);
                page.dialogs.elements.balanceDep.val(customer.balance);
                page.dialogs.elements.transactionAmountDep.val(0);


                page.dialogs.elements.modalDeposit.modal('show');
            })
                .catch((error) => {
                    console.log(error);
                });
        }

        page.commands.handleAddEventShowModalWithDraw = (customerId) => {
            page.commands.getCustomerById(customerId).then((data) => {
                customer = data;
                page.dialogs.elements.fullNameWd.val(customer.fullName);
                page.dialogs.elements.emailWd.val(customer.email);
                page.dialogs.elements.balanceWd.val(customer.balance);
                page.dialogs.elements.transactionAmountWd.val(0);


                page.dialogs.elements.modalWithdraw.modal('show');
            })
                .catch((error) => {
                    console.log(error);
                });
        }

        page.commands.handleAddEventConfirmDelete = (customerId) => {
            page.commands.getCustomerById(customerId).then((data) => {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        page.dialogs.commands.doDelete(customerId).then(() => {
                            $('#tr_' + customerId).remove()
                            Swal.fire({
                                position: 'center',
                                icon: 'success',
                                title: 'Khách hàng đã được xoá',
                                showConfirmButton: false,
                                timer: 2500
                            })
                        })
                            .catch((error) => {
                                console.log(error);
                            })
                    }
                })
            })
        }

        page.commands.HandleAddEventTransfer = (customerI) => {
                page.commands.getCustomerById(customerId).then((data) => {
                    if (data !== {} ) {
                        page.dialogs.elements.fullNameSent.val(data.fullName);
                        page.dialogs.elements.balanceSent.val(data.balance);
                        page.dialogs.elements.transactionAmountSent.val('');
                        page.dialogs.elements.transactionAmountSent.val('');
                        page.dialogs.elements.transactionAmountFee.val('');
                        page.dialogs.elements.modalTransfer.modal('show');
                    }
                    else {
                        alert('Customer not found');
                    }
                })
                    .catch((error) => {
                        console.log(error);
                    });
            }


        page.dialogs.commands.create = () => {
            const fullName = page.dialogs.elements.fullNameCre.val();
            const email = page.dialogs.elements.emailCre.val();
            const phone = page.dialogs.elements.phoneCre.val();
            const address = page.dialogs.elements.addressCre.val();
            const balance = 0;
            const deleted = 0;

            const obj = {
                fullName,
                email,
                phone,
                address,
                balance,
                deleted
            }

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.url.createCustomer,
                data: JSON.stringify(obj)
            })
                .done((data) => {
                    const str = page.commands.renderCustomer(data);
                    page.elements.tbCustomerBody.prepend(str);

                    page.dialogs.elements.modalCreate.modal('hide');

                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'Thêm mới khách hàng thành công',
                        showConfirmButton: false,
                        timer: 1500
                    })

                })
                .fail((error) => {
                    console.log(error);
                })

        }

        page.dialogs.commands.update = (obj) => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.url.updateCustomer + '/' + customerId,
                data: JSON.stringify(obj)
            })
                .done((data) => {
                    const str = page.commands.renderCustomer(data);

                    const currentRow = $('#tr_' + customerId);
                    currentRow.replaceWith(str);

                    page.dialogs.elements.modalUpdate.modal('hide');
                })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.dialogs.commands.deposit = (customer, deposit) => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.url.incrementBalance + '/' + customerId,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    const str = page.commands.renderCustomer(data);

                    const currentRow = $('#tr_' + customerId);
                    currentRow.replaceWith(str);

                    page.dialogs.elements.modalDeposit.modal('hide');
                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'Nạp tiền thành công',
                        showConfirmButton: false,
                        timer: 1500
                    })
                })
                .fail((error) => {
                    console.log(error);
                })

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.url.deposit,
                data: JSON.stringify(deposit)
            })
                .done((data) => {

                })
                .fail((error) => {
                    console.log(error);
                })
        }

        page.dialogs.commands.withdraw = (customer, withdraw) => {
            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.url.descrementBalance + '/' + customerId,
                data: JSON.stringify(customer)
            })
                .done((data) => {
                    const str = page.commands.renderCustomer(data);

                    const currentRow = $('#tr_' + customerId);
                    currentRow.replaceWith(str);

                    page.dialogs.elements.modalWithdraw.modal('hide');
                    Swal.fire({
                        position: 'center',
                        icon: 'success',
                        title: 'Rút tiền thành công',
                        showConfirmButton: false,
                        timer: 1500
                    })
                })
                .fail((error) => {
                    console.log(error);
                })

            $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'POST',
                url: page.url.withdraw,
                data: JSON.stringify(withdraw)
            })
                .done((data) => {

                })
                .fail((error) => {
                    console.log(error);
                })
        }


        page.dialogs.commands.doDelete = (id) => {
            const obj = {
                deleted: 1
            }

            return $.ajax({
                headers: {
                    'accept': 'application/json',
                    'content-type': 'application/json'
                },
                type: 'PATCH',
                url: page.url.getCustomerById + '/' + id,
                data: JSON.stringify(obj)
            })
        }

        

        $(document).ready(function () {
            page.commands.getCustomers();
        });


        $(document).ready(function () {
            let transactionAmountSent = $('#transactionAmountSent');
            let transactionAmountTotal = $('#transactionAmountTotal');
            let transactionAmountFee = $('#transactionAmountFee');

            transactionAmountSent.on('input', function () {
                let amountSent = parseFloat(transactionAmountSent.val());
                let fee = amountSent * 0.1;
                let total = amountSent + fee;

                transactionAmountFee.val(fee);
                transactionAmountTotal.val(total);
            });
        });

        page.commands.getCustomers = (customerId) => {
            $.ajax({
                url: page.url.getCustomerById,
                type: 'GET',
                dataType: 'json',
                success: function (customers) {
                    var recipientSelect = $('#recipientSelect');
                    recipientSelect.empty();
                    recipientSelect.append($('<option>').val('').text('Select recipient'));

                    $.each(customers, function (index, customer) {
                        if (customer.id !== customerId && customer.deleted == 0) {
                            
                            recipientSelect.append($('<option>').val(customer.id).text(customer.id + '-' + customer.fullName));
                        }
                    });
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Error: ' + textStatus + ' ' + errorThrown);
                }
            });
        }

        page.dialogs.elements.btnTransfer.on('click', () => {
            let recipientId = $('#recipientSelect').val();
            if (!recipientId) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Please select a recipient !!!'
                });
                return;
            }
            let balanceSent = +$('#balanceSent').val();
            let transactionAmountSent = +$('#transactionAmountSent').val();
            let transactionFee = transactionAmountSent * 0.1;
            let transactionTotal = transactionAmountSent + transactionFee;
            if (!transactionAmountSent || isNaN(transactionAmountSent) || transactionAmountSent <= 0) {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'Transaction amount must be a positive number !!!'
                });
                return;
            }
            page.commands.getCustomerById(recipientId)
                .then((recipient) => {
                    let balanceAfterTransfer = balanceSent - transactionTotal;
                    if (balanceAfterTransfer < 0) {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Not enough amount to transfer !!!'
                        });
                        return;
                    }
                    console.log(recipient)
                    page.commands.getCustomerById(customerId)
                        .then((sender) => {
                            let senderData = {
                                id: sender.id,
                                fullName: sender.fullName,
                                phone: sender.phone,
                                email: sender.email,
                                address: sender.address,
                                balance: balanceAfterTransfer
                            };
                            let recipientData = {
                                id: recipient.id,
                                fullName: recipient.fullName,
                                phone: recipient.phone,
                                email: recipient.email,
                                address: recipient.address,
                                balance: recipient.balance + transactionAmountSent
                            };
                            return Promise.all([
                                $.ajax({
                                    type: 'POST',
                                    headers: {
                                        'accept': 'application/json',
                                        'content-type': 'application/json'
                                    },
                                    url: 'http://localhost:3300/transfers',
                                    data: JSON.stringify({
                                        senderId: senderData.id,
                                        senderFullname: senderData.fullName,
                                        transactionAmount: transactionAmountSent,
                                        recipientId: recipientId,
                                        transactionFee: transactionFee,
                                        recipientFullname: recipientData.fullName
                                    })
                                }),
                                
                                $.ajax({
                                    type: 'PATCH',
                                    headers: {
                                        'accept': 'application/json',
                                        'content-type': 'application/json'
                                    },
                                    url: 'http://localhost:3300/customers/' + senderData.id,
                                    data: JSON.stringify(senderData)
                                }),
                                $.ajax({
                                    type: 'PATCH',
                                    headers: {
                                        'accept': 'application/json',
                                        'content-type': 'application/json'
                                    },
                                    url: 'http://localhost:3300/customers/' + recipientId,
                                    data: JSON.stringify(recipientData)
                                })
                            ])
                                .then(([transferRes, senderRes, recipientRes]) => {
                                    let senderStr = page.commands.renderCustomer(senderData);
                                    let recipientStr = page.commands.renderCustomer(recipientData);
                                    $('#tr_' + senderData.id).replaceWith(senderStr);
                                    $('#tr_' + recipientData.id).replaceWith(recipientStr);

                                    $('#mdTransfer').modal('hide');
                                    Swal.fire({
                                        position: 'center',
                                        icon: 'success',
                                        title: 'Chuyển khoản thành công',
                                        showConfirmButton: false,
                                        timer: 1500
                                    });
                                });
                        })
                })
                .catch((error) => {
                    console.log(error);
                });
        });


        page.initializeControlEvent = () => {
            page.elements.btnShowCreateModal.on('click', () => {
                page.dialogs.elements.modalCreate.modal('show');
            })

            page.dialogs.elements.btnCreate.on('click', () => {
                page.dialogs.commands.create();
            })

            page.elements.tbCustomerBody.on('click', '.edit', function () {
                customerId = $(this).data('id');
                page.commands.handleAddEventShowModalUpdate(customerId);
            })

            page.elements.tbCustomerBody.on('click', '.deposit', function () {
                customerId = $(this).data('id');
                page.commands.handleAddEventShowModalDeposit(customerId);
            })

            page.elements.tbCustomerBody.on('click', '.withdraw', function () {
                customerId = $(this).data('id');
                console.log(customerId)
                page.commands.handleAddEventShowModalWithDraw(customerId);
            })

            page.elements.tbCustomerBody.on('click' , '.delete' ,function() {
                customerId = $(this).data('id');
                console.log(customerId)
                page.commands.handleAddEventConfirmDelete(customerId);
            })

            page.elements.tbCustomerBody.on('click', '.transfer' , function () {
                customerId = $(this).data('id');
                page.commands.getCustomers(customerId);
                page.commands.HandleAddEventTransfer(customerId)
            })

            page.dialogs.elements.btnUpdate.on('click', () => {
                const fullName = page.dialogs.elements.fullNameUp.val();
                const email = page.dialogs.elements.emailUp.val();
                const phone = page.dialogs.elements.phoneUp.val();
                const address = page.dialogs.elements.addressUp.val();

                delete customer.id;
                customer.fullName = fullName;
                customer.email = email;
                customer.phone = phone;
                customer.address = address;

                page.dialogs.commands.update(customer);
            })

            page.dialogs.commands.closeModalCreate = () => {
                page.dialogs.elements.frmCreate[0].reset();
            }

            page.dialogs.elements.btnDeposit.on('click', () => {

                const currentBalance = customer.balance;
                const transactionAmount = +$('#transactionAmountDep').val();
                const newBalance = currentBalance + transactionAmount;
                customer.balance = newBalance;

                deposit.id = null;
                deposit.customerId = customerId;
                deposit.transactionAmount = transactionAmount;

                page.dialogs.commands.deposit(customer, deposit);

            })
            page.dialogs.elements.btnWithdraw.on('click', () => {

                const currentBalance = customer.balance;
                const transactionAmount = +$('#transactionAmountWd').val();
                console.log(transactionAmount);
                const newBalance = currentBalance - transactionAmount;
                if (transactionAmount > currentBalance) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Transaction amount cannot be greater than current balance!'
                    });
                    return;
                }
                if (isNaN(transactionAmount) || transactionAmount < 0 || !transactionAmount) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Transaction amount must be a positive number !!!'
                    });
                    return;
                }

                customer.balance = newBalance;

                withdraw.id = null;
                withdraw.customerId = customerId;
                withdraw.transactionAmount = transactionAmount;

                page.dialogs.commands.withdraw(customer, withdraw);

            })

            page.dialogs.elements.modalCreate.on("hidden.bs.modal", function () {
                page.dialogs.commands.closeModalCreate();
            });

        }

        page.loadData = () => {
            page.commands.getAllCustomers();
        }

        $(() => {
            page.loadData();

            page.initializeControlEvent();
        })




    </script>
</body>

</html>